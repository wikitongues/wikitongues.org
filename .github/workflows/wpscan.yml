name: WPScan

# Requires two repository secrets:
#   PRODUCTION_URL    — e.g. https://wikitongues.org
#   WPSCAN_API_TOKEN  — free token from https://wpscan.com/api (25 req/day)

on:
  schedule:
    - cron: '0 9 * * 1' # Every Monday at 09:00 UTC
  workflow_dispatch:

jobs:
  wpscan:
    name: WordPress vulnerability scan
    runs-on: ubuntu-latest
    steps:
      - name: Verify secrets are configured
        env:
          TOKEN: ${{ secrets.WPSCAN_API_TOKEN }}
          URL: ${{ secrets.PRODUCTION_URL }}
        run: |
          if [ -z "$TOKEN" ] || [ -z "$URL" ]; then
            echo "::error::WPSCAN_API_TOKEN and PRODUCTION_URL must be set in repository secrets."
            echo "::error::Get a free API token at https://wpscan.com/api"
            exit 1
          fi

      # Pinned to 3.8.28 — update when upgrading
      - name: Install WPScan
        run: gem install wpscan -v 3.8.28 --no-document

      - name: Run WPScan
        env:
          WPSCAN_API_TOKEN: ${{ secrets.WPSCAN_API_TOKEN }}
          PRODUCTION_URL: ${{ secrets.PRODUCTION_URL }}
        run: |
          wpscan \
            --url "$PRODUCTION_URL" \
            --api-token "$WPSCAN_API_TOKEN" \
            --enumerate vp,vt \
            --plugins-detection mixed \
            --no-update \
            --ignore-main-redirect \
            --format cli-no-colour
